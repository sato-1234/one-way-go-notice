# 要件定義書：レンタカー情報スクレイピング機能

## 1. 概要

トヨタレンタカーの「片道 GO」公式サイトから、現在利用可能な片道レンタカーの情報を定期的に取得し、アプリケーションで利用できる形式のデータを提供する。

## 2. 背景と目的

ユーザーに対して、リアルタイムで予約可能な片道レンタカーの一覧を提示するため。公式サイトを常時確認する手間を省き、利便性を向上させることを目的とする。

## 3. 機能要件

### 3.1. データ取得

- **取得元 URL:** `https://cp.toyota.jp/rentacar/`
- **取得対象:**
  - 「受付中」の片道レンタカー情報のみを取得する。
  - `ul` 要素に `#service-items-shop-type-start` id が含まれるものを最初に取得
  - `li` 要素に `.show-entry-end` クラスが含まれるものは「受付終了」とみなし、取得対象外とする。対象の li を 1 個ずつ取得して[{},{},・・・]の配列形式で格納後、最終的に JSON 形式にしてレスポンスする。

### 3.2. 抽出データ項目

取得した各レンタカー情報から、以下の項目を抽出し、JSON オブジェクトとして整形する。

| No. | 項目名   | データ構造 (例)           | 抽出元セレクタ/ロジック                                     | 備考                           |
| :-- | :------- | :------------------------ | :---------------------------------------------------------- | :----------------------------- |
| 1   | 出発店舗 | `{ name, branch, small }` | `.service-item__shop-start`                                 | 店舗名、支店名、補足情報に分割 |
| 2   | 返却店舗 | `(string)`                | `.service-item__shop-return`                                |                                |
| 3   | 車種     | `(string)`                | `.service-item__info__car-type`                             | 車両番号は除外                 |
| 4   | 車両条件 | `(string)`                | `.service-item__info__condition`                            |                                |
| 5   | 出発期間 | `{ start, end }`          | `.service-item__info__date`                                 | `YYYY-MM-DD`形式に整形         |
| 6   | 予約電話 | `{ shop, tel }`           | `.service-item__reserve-shop`, `.service-item__reserve-tel` |                                |

### 3.3. データ永続化

- 抽出したデータと実行ステータスは、**Cloudflare D1** データベースに保存する。
- 差分比較のため、「最新のスクレイピング結果」と「前回のスクレイピング結果」を保持する。

#### 3.3.1. テーブル定義

1.  **`scraped_data`**: スクレイピングで取得したレンタカー情報を格納する。

| カラム名            | 型      | 説明                               |
| :------------------ | :------ | :--------------------------------- |
| `id`                | INTEGER | 主キー (自動採番)                  |
| `execution_id`      | TEXT    | 実行 ID (どの実行で取得したか)     |
| `is_latest`         | INTEGER | 最新データの場合は 1、それ以外は 0 |
| `departure_store`   | TEXT    | 出発店舗 (JSON 文字列)             |
| `return_store`      | TEXT    | 返却店舗                           |
| `car_type`          | TEXT    | 車種 (JSON 文字列)                 |
| `car_condition`     | TEXT    | 車両条件                           |
| `departure_period`  | TEXT    | 出発期間 (JSON 文字列)             |
| `reservation_phone` | TEXT    | 予約電話 (JSON 文字列)             |
| `created_at`        | TEXT    | 作成日時 (ISO 8601)                |

2.  **`scraping_metadata`**: スクレイピング処理の全体的な状態を管理する。

status の permanent_error は、恒久エラーのこと。手動復旧が必要。

status の after_restoration は、恒久エラーの手動復旧時の手動で設定する値。

| カラム名                    | 型      | 説明                                                                      |
| :-------------------------- | :------ | :------------------------------------------------------------------------ |
| `id`                        | INTEGER | 主キー (常に 1)                                                           |
| `status`                    | TEXT    | 現在の状態 (`ok`, `timeout_error`, `permanent_error`,`after_restoration`) |
| `consecutive_timeout_count` | INTEGER | 連続タイムアウト回数                                                      |
| `halted_until`              | TEXT    | 一時停止が解除される日時 (ISO 8601)                                       |
| `updated_at`                | TEXT    | 最終更新日時 (ISO 8601)                                                   |

## 4. 非機能要件

### 4.1. 実行スケジュール

- **メイン処理:** 毎日 07:00 から 21:00 まで、**1 分間隔**で実行する。
- **サマリーログ出力:** 毎日 22:00 に、その日の結果をログに出力する。

### 4.2. パフォーマンス

- スクレイピング処理のタイムアウト時間は **15 秒** とする。

### 4.3. エラーハンドリングと耐障害性

#### 4.3.1. 恒久的なエラー

復旧のアクションとして、「status を after_restoration に変更する」ことを明確化。

- **定義:** サイト構造の変更、URL の変更など、開発者のコード修正が必要なエラー。
- **検知条件:** タイムアウト以外のすべてのエラー。
- **アクション:**
  1. システム状態を `permanent_error'` に設定する。
  2. 開発者に LINE で「障害発生」を通知する（初回のみ）。
  3. 以降のスクレイピング処理を完全に停止する。
  4. **復旧には開発者の手動介入（既存コードの修正）を必須とする。**
  5. **手動復旧時は「status を after_restoration に変更」すること。**

#### 4.3.2. 一時的なエラー（サーキットブレーカー）

- **定義:** ターゲットサイトのサーバー負荷などによる、一時的なタイムアウト。
- **検知条件:** タイムアウトが **5 回連続** で発生した場合。
- **アクション:**
  1. システム状態を `timeout_error` に設定する。
  2. **5 分間**、スクレイピング処理を一時的に停止する。
  3. 5 分経過後、自動的に処理を再開する。
  4. 処理が 1 回でも成功すれば、連続タイムアウトカウンターはリセットされる。

## 5. その他

- 本機能は Cloudflare Pages Functions 上で、Hono フレームワークを用いて実装される。理由は、アーキテクチャを、より具体的に、かつ正確に記述するため。
- HTML の解析には `axios` と `cheerio` を利用する。

## 6. 抽出データ項目の詳細（以下は例）

```
// 出発店舗 取得元
<div class="service-item__shop-start">
  <p class="label-sp">出発<br />店舗</p>
  <p>トヨタレンタリース愛知 高岳店 <small>（愛知県 名古屋市）</small></p>
 </div>

// 出発店舗 取得後の状態
出発店舗.name:トヨタレンタリース愛知
出発店舗.banch:高岳店
出発店舗.small:（愛知県 名古屋市）


// 返却店舗 取得元
<div class="service-item__shop-return">
  <p class="label-sp">返却<br />店舗</p>
  <p>トヨタレンタリース大阪 返却可能店舗 <small>（下記参照）</small></p>
</div>

// 返却店舗 取得後の状態
返却店舗:トヨタレンタリース大阪


// 車種 取得元（「車両番号」を含む多様なパターンがある）
<div class="service-item__info__car-type">
  <p class="label-sp">車種</p>
  <p>スズキエブリィバン　車両番号1305</p>
</div>

// 車種 取得後の状態
車種:スズキエブリィバン
車両番号:1305（ないときもあるので任意）


// 車両条件 取得元
<div class="service-item__info__condition">
  <p class="label-sp">車両条件</p>
  <p>禁煙・4名乗り</p>
</div>

// 車両条件 取得後の状態
車両条件:禁煙・4名乗り


// 出発期間 取得元
<div class="service-item__info__date">
  <p></p>
  2025年7月15日 ～ 7月18日
  <p></p>
 </div>

// 出発期間 取得後の状態
出発期間.start:2025-07-15
出発期間.end:2025-07-18


// 予約電話 取得元
<div class="service-item__reserve">
  <p class="label-sp">予約電話番号</p>
  <div class="wrapper">
    <div class="service-item__reserve-shop">総合予約室</div>
    <div class="service-item__reserve-tel">0120-001-319</div>
  </div>
</div>

// 予約電話 取得後の状態
予約電話.shop:総合予約室
予約電話.tel:0120-001-319
```
