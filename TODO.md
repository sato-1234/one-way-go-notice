# プロジェクト TODO リスト

このプロジェクトで今後実装が必要なタスクの一覧です。

## 1. 基盤構築・設定 (Infrastructure & Setup)

- [ ] **Cloudflare Cron Triggers の設定**
  - [ ] メインのスクレイピング用 Cron (`/api/scrape`) を設定する (07:00-21:00, 1 分毎)。
  - [ ] 日々のメンテナンス用 Cron (`/api/scrape/summary`) を設定する (22:00)。

## 2. バックエンド (Backend)

- [ ] **日次サマリーログ用 API の作成**

  - `/api/scrape/summary` または `/api/summary`という新しい API ルートを作成し、スクレイピング関係する日々のメンテナンス処理を実装
  - 本日の結果をログで出力：DB からメタデータを読み込んでログ出力する処理を実装する。（現状のステータス、本日のスクレイピング成功数など）
  - 店舗の整合性処理：定数ファイルと店舗スクレイピング情報を比較して、100%一致しているか確認処理を実装する
  - 不要データ削除：スクレイピングで取得情報でステータスが「0」のレコードだけ削除

- [ ] **LINE 通知機能の実装**
  - LINE 通知を送るための API キーなどを環境変数に設定する。
  - API 処理で `★★` コメント部分に、実際の LINE 通知 API を呼び出すコードを実装する。

## 3. フロントエンド (Frontend)

- [ ] **ダッシュボードへのスクレイピング結果表示**

  - [ ] Dashboard ページ (`/dashboard`) で、1 分ごとに D1 からデータを取得(useEffect と setInterval などを使って、1 分ごとに DB からデータを取得する API を呼び出し、一覧を自動更新するロジックを実装します)
  - [ ] 取得したレンタカー情報の一覧をカード形式などで分かりやすく表示する。
  - [ ] ローディング中やデータが 0 件の場合の表示も考慮する。

- [ ] **エラー発生時のメンテナンス表示**

  - `/api/scrape` からのレスポンスが恒久エラー（ステータス 500, 503, 504 など）の場合、Dashboard ページに「現在メンテナンス中です」などのメッセージを表示する（ステータスを受け取り、フロント画面にメンテナンス中と表示する）

- [ ] **通知条件フォームの実装**
  - [ ] 通知条件を CRUD（作成・読取・更新・削除）するためのテーブルを D1 に作成する。
  - [ ] 共通モーダル UI を使って、通知条件の入力フォームを作成する。

```
-- 条件テーブルの構造イメージ
id INTEGER PRIMARY KEY AUTOINCREMENT, -- 主キー (自動採番) \n
line_idまたはログインユーザーを認識できるID,　-- ユーザーは複数条件を登録できるため、一意にはならない） \n
notification_type, -- 通知タイプで「LINE」と「MAIL（今後開発予定）」が挿入される \n
departure_region TEXT NOT NULL, -- 出発地域（条件1）スクレイピングした出発店舗がその地域に含む場合、true（値がすべてもtrue） \n
departure_store TEXT NOT NULL, -- 出発店舗（条件2）スクレイピングした出発店舗と比較して一致なら、true（値がすべてもtrue） \n
return_region TEXT NOT NULL, -- 返却地域（条件3）スクレイピングした返却店舗がその地域に含む場合、true（値がすべてもtrue） \n
return_store TEXT NOT NULL, -- 返却店舗（条件4）スクレイピングした返却店舗と比較して一致なら、true（（値がすべてもtrue） \n
car_type TEXT NOT NULL, -- 車種（条件5）スクレイピングした車種と比較。一部一致の場合、true（値が空の場合もtrue） \n
departure_period TEXT NOT NULL, -- 出発期間（条件6）スクレイピングした出発期間に含の場合、true（値が空の場合もtrue） \n
```

## 4. セキュリティ強化 (Security Hardening)

- [ ] **継続的なセキュリティスキャンの導入**
  - [ ] **Snyk** を導入し、GitHub App と連携させて依存関係の脆弱性を自動スキャン・修正する体制を構築する（https://snyk.io/jp/）。
  - [ ] **CodeQL** を導入し、GitHub Actions でソースコードの静的解析を自動化する。

## 5. 5. デプロイと本番設定 (Deployment & Production Setup)

- [ ] **Cloudflare Pages と GitHub の連携**

  - [ ] `main`ブランチへの push をトリガーとした、CI/CD による自動デプロイを設定する。
  - [ ] 本番用の環境変数（API キー、許可オリジン等）と D1 バインディングを設定する。

- [ ] **Cloudflare WAF による IP アドレス制限**

  - Worker (Pages Function) へのアクセスを、Cloudflare ネットワーク内部からのみに制限するファイアウォールルールを適用する（ IP アドレスのセキュリティ対策）。

- [ ] **Clerk の本番キー設定**
  - Clerk のキーを、開発用から本番用に切り替えてデプロイする。
